# 第2回：LLMノードとプロンプト設計

## この回で学ぶこと

- LLMノードの基本的な使い方
- 効果的なプロンプトの書き方
- 変数を使った動的なプロンプト作成
- 実際に動くAIアプリケーションの作成

**前提知識：** プログラミングの知識は不要です。Difyの画面操作のみで学習できます。

---

## 目次

1. [LLMノードとは](#1-llmノードとは)
2. [LLMノードの追加と設定](#2-llmノードの追加と設定)
3. [プロンプトの書き方](#3-プロンプトの書き方)
4. [変数を使ったプロンプト](#4-変数を使ったプロンプト)
5. [実践：AIアシスタントを作る](#5-実践aiアシスタントを作る)

---

## 1. LLMノードとは

### LLMノードの役割

**LLMノード**は、ChatGPTやClaudeなどのAIモデルと会話するための部品です。

```
[ユーザーの質問] → [LLMノード] → [AIの回答]
```

### できること

- 質問に答える
- 文章を要約する
- 翻訳する
- アイデアを出す
- 文章を添削する
- など、さまざまなタスク

### ストリーミングとブロッキング

LLMノードには2つの動作モードがあります。基本的には**ストリーミング**がおすすめです。

#### ストリーミングモード（推奨）
AIが考えながら、一文字ずつリアルタイムに表示するモードです。
```
「こんに」「ちは」「、」「今日」「は」...
```
**メリット：** 待ち時間が短く感じられ、ChatGPTのようなスムーズな体験になります。

#### ブロッキングモード
AIが回答をすべて作り終えてから、一度に表示するモードです。
```
（考え中...）
↓
「こんにちは、今日はいい天気ですね」
```
**メリット：** 途中の表示が不要な場合や、他のシステムと連携する場合に使います。

---

## 2. LLMノードの追加と設定

### ステップ1: アプリケーションを作成

Difyには主に2つのアプリ作成モードがあります。今回は基本を学ぶため「ワークフロー」を使います。

1. Difyにログイン
2. 左メニューから「スタジオ」をクリック
3. 「空白のワークフローから作成」を選択
   - **注意：** 「チャットボット」を選ぶと画面構成が少し異なります
4. アプリ名を入力（例：「はじめてのLLM」）

### ステップ2: LLMノードを追加

1. キャンバス（編集画面）にある「開始」ノードの右側の「＋」をクリック
   - または、画面左上の「＋」から追加も可能です
2. ノード一覧から「LLM」を選択
3. LLMノードが追加され、線でつながります

### ステップ3: モデルを選択

LLMノードをクリックして設定画面を開きます：

**モデルの選択：**
- **Gemini**：Googleのモデル

**初心者におすすめ：** まずは「gemini-2.5-flash」から始めましょう

### ステップ4: パラメータ設定

LLMノードの右側パネルで、以下のパラメータを設定できます。

#### ストリーミング出力

**ワークフローでの設定：**
- ワークフロー型アプリケーションでは、LLMノードの出力は**デフォルトでストリーミング対応**になっています
- 特別な設定は不要で、自動的にリアルタイム表示されます

**チャットボットアプリでの設定：**
- アプリ公開時に「応答モード」を選択できます
  - **ストリーミング**：リアルタイムで文字が表示される（推奨）
  - **ブロッキング**：回答が完成してから一括表示

**注意：** ワークフロー内のLLMノード自体には、ストリーミングのオン/オフ切り替えスイッチはありません。出力の表示方法は、アプリケーションの種類や公開設定によって決まります。

#### Temperature（温度）

AIの「創造性」を調整します：

| 設定値 | 動作 | 使いどころ |
|--------|------|-----------|
| **0.0** | 毎回同じ答え | 計算問題、正確な情報 |
| **0.5** | バランス | 一般的なQ&A |
| **0.9** | 創造的な答え | 物語作成、アイデア出し |

**例：**
```
質問：「1+1は？」

Temperature 0.0 → 毎回「2です」
Temperature 0.9 → 「2です」「二つです」「2ですね」など変化
```

#### Maximum Tokens（最大トークン数）

AIが生成する文章の長さの上限です。
※「トークン」はAIが言葉を扱う単位で、日本語の場合「1トークン ≒ 0.5〜1文字」程度です。

| 設定値 | 目安 |
|--------|------|
| **512** | 短い回答（数行〜1段落） |
| **1024** | 標準的な回答（400〜800文字程度） |
| **2048** | 長文の生成（ブログ記事など） |
| **4096+** | 非常に長いレポートや詳細な解説 |

**注意：** トークン数が多いほど、生成に時間がかかり、コストも高くなる傾向があります。

#### Response Format（応答形式）

- **Text**：普通のテキスト（通常はこれ）
- **JSON**：構造化されたデータが必要な場合

---

## 3. プロンプトの書き方

### プロンプトとは

AIに対する「指示文」のことです。プロンプトの良し悪しで、AIの回答の質が大きく変わります。

### 基本的なプロンプトの構成

```
[役割] + [タスク] + [制約条件] + [出力形式]
```

### 例1: シンプルなプロンプト

**悪い例：**
```
説明して
```
→ 何を説明するのか不明確

**良い例：**
```
あなたは親切な先生です。
プロンプトエンジニアリングについて、小学生にもわかるように説明してください。
```
→ 役割とタスクが明確

### 例2: 詳細なプロンプト

```
【役割】
あなたは経験豊富なカスタマーサポート担当者です。

【タスク】
顧客からの問い合わせに対して、丁寧で分かりやすい回答を作成してください。

【制約条件】
- 敬語を使用すること
- 回答は300文字以内
- 専門用語は避けること
- 必要に応じて具体例を示すこと

【出力形式】
以下の形式で回答してください：
1. お問い合わせ内容の確認
2. 回答
3. 追加で必要な情報があれば案内
```

### プロンプトのテクニック

#### 💡 プロのテクニック：AIにプロンプトを書いてもらう

自分でゼロからプロンプトを書くのが難しい場合は、Difyの**自動生成機能**を使いましょう。

1. プロンプト入力欄の右上にある「✨（キラキラアイコン）」をクリック
2. やりたいことを一言入力（例：「美味しいカレーの作り方を教えるボット」）
3. 「生成」ボタンを押す
4. AIが考えた詳細なプロンプトが自動で入力されます

これを使えば、プロンプトエンジニアリングの知識がなくても高品質な指示が作れます。

#### テクニック1: Few-shot（例示）

AIに「お手本」を見せる方法：

```
以下の例を参考に、商品レビューを分類してください。

【例1】
レビュー：「とても良い商品でした！」
分類：ポジティブ

【例2】
レビュー：「期待外れでした」
分類：ネガティブ

【分類してください】
レビュー：「普通です」
分類：
```

#### テクニック2: ステップバイステップ

複雑なタスクを段階的に実行：

```
以下の手順で文章を要約してください：

ステップ1：文章の主題を特定する
ステップ2：重要なポイントを3つ抜き出す
ステップ3：各ポイントを1文にまとめる
ステップ4：3つの文を組み合わせて要約を作る

文章：
{ここにユーザーの文章が入る}
```

#### テクニック3: ペルソナ設定

AIに具体的な役割を与える：

```
あなたは以下の設定のキャラクターです：
- 名前：さくらAI
- 性格：明るく親しみやすい
- 口調：「です・ます」調
- 特徴：絵文字を適度に使う（多用しない）

この設定で、ユーザーの質問に答えてください。
```

---

## 4. 変数を使ったプロンプト

### 変数とは

**変数**は、ユーザーの入力や他のノードの結果を受け取る「箱」のようなものです。
この箱に毎回違う言葉を入れることで、同じプロンプトでも異なる回答を作ることができます。

```
変数なし：「天気について教えて」
→ 毎回「天気」についてしか答えない

変数あり：「{{topic}}について教えて」
→ 箱(topic)に「料理」を入れると...「料理について教えて」になる
→ 箱(topic)に「歴史」を入れると...「歴史について教えて」になる
```

### 開始ブロック（開始ノード）とは

**開始ブロック**は、ワークフローの入り口となる特別なノードです。ここで定義した変数が、ユーザーからの入力を受け取ります。

#### 開始ブロックの役割

```
[ユーザー] → 入力 → [開始ブロック] → 変数として保存 → [LLMノードなどで使用]
```

**主な機能：**
- ユーザーからの入力を受け取る
- 入力の種類（テキスト、ファイル、数値など）を定義
- 必須/任意の設定
- デフォルト値の設定

#### 開始ブロックで設定できる項目

| 項目 | 説明 | 例 |
|------|------|-----|
| **フィールド名** | 変数の名前（英数字とアンダースコア） | `user_question`, `topic`, `input_text` |
| **フィールドタイプ** | データの種類 | テキスト、段落、数値、ファイルなど |
| **必須** | 入力が必須かどうか | はい/いいえ |
| **説明** | ユーザーへの入力ガイド | 「質問を入力してください」 |
| **デフォルト値** | 初期値（オプション） | 「こんにちは」 |

#### フィールドタイプの種類

1. **テキスト（Text）**
   - 短い1行の入力
   - 例：名前、タイトル、キーワード

2. **段落（Paragraph）**
   - 複数行の長文入力
   - 例：質問文、レビュー、記事

3. **数値（Number）**
   - 数字のみの入力
   - 例：年齢、金額、文字数

4. **ファイル（File）**
   - ファイルのアップロード
   - 例：画像、PDF、CSV

5. **選択（Select）**
   - プルダウンからの選択
   - 例：「簡単/普通/詳しく」「日本語/英語」

#### 開始ブロックの変数と会話変数の違い

Difyには2種類の変数があります。それぞれの特徴と使い分けを理解しましょう。

##### 1. 開始ブロックの変数（入力変数）

**特徴：**
- ワークフローが**実行されるたびに**ユーザーから入力を受け取る
- 1回のワークフロー実行中のみ有効
- ワークフローが終わると値は消える

**用途例：**
```
質問応答ボット
→ 毎回異なる質問を受け付ける
→ 質問ごとに新しい値が入力される
```

**ライフサイクル：**
```
[ワークフロー開始] → 変数に値を設定 → 処理実行 → [ワークフロー終了] → 値が消える
```

##### 2. 会話変数（Conversation Variables）

**特徴：**
- **複数回の会話を通じて**値を保持し続ける
- チャットボットアプリで使用
- ユーザーとの会話履歴全体で共有される

**用途例：**
```
カスタマーサポートチャット
→ 1回目：顧客名「山田太郎」を記憶
→ 2回目：「山田様、前回のご注文について...」と前回の情報を参照
→ 3回目：過去の会話内容を踏まえた対応
```

**ライフサイクル：**
```
[会話開始] → 変数に値を保存 → [会話継続] → 値を参照・更新 → [会話終了] → 値が保存される
```

##### 比較表

| 項目 | 開始ブロックの変数 | 会話変数 |
|------|-------------------|----------|
| **スコープ** | 1回のワークフロー実行 | 会話全体（複数回のやり取り） |
| **設定場所** | 開始ノード | ワークフロー設定 |
| **値の保持** | ワークフロー終了で消える | 会話が続く限り保持 |
| **使用場面** | ワークフロー型アプリ | チャットボット型アプリ |
| **更新方法** | 毎回ユーザーが入力 | ワークフロー内で更新可能 |
| **例** | `{{question}}`, `{{topic}}` | `{{customer_name}}`, `{{order_id}}` |

##### 使い分けの例

**例1: 質問応答ボット（開始ブロックの変数を使用）**
```
ユーザー入力: 「プロンプトとは？」
→ 開始変数 question = "プロンプトとは？"
→ LLMが回答
→ ワークフロー終了（変数消える）

次の質問: 「温度パラメータとは？」
→ 新しい開始変数 question = "温度パラメータとは？"
→ 前回の質問は関係なし
```

**例2: カスタマーサポート（会話変数を使用）**
```
1回目の会話:
ユーザー: 「注文したいです」
→ 会話変数 customer_name = "山田太郎" を保存
→ 会話変数 order_status = "相談中" を保存

2回目の会話（同じセッション内）:
ユーザー: 「配送先を変更したい」
→ 会話変数から customer_name を参照 → "山田様"
→ 会話変数から order_status を参照 → "相談中"
→ 前回の文脈を踏まえた対応が可能
```

##### 重要なポイント：アプリ種類の使い分け

| アプリの種類 | 特徴 | 向いていること |
|------------|------|----------------|
| **ワークフロー** | 1回完結型 | 記事生成、翻訳、分析、データ処理 |
| **チャットボット** | 会話継続型 | 質問応答、相談相手、カスタマーサポート |

※今回の演習では、仕組みを理解しやすい「ワークフロー」を使いますが、実際のチャットボット作りでは「チャットボット（Chatflow）」モードを使うのが一般的です。

### 入力変数の作成

#### ステップ1: 開始ノードで変数を定義

1. **開始ノード**をクリック
2. 「入力フィールドを追加」をクリック
3. 以下を設定：
   - **フィールド名**：`user_question`
   - **フィールドタイプ**：テキスト
   - **必須**：はい
   - **説明**：ユーザーの質問

#### ステップ2: プロンプトで変数を使用

LLMノードのプロンプト欄に以下を入力：

```
あなたは何でも答えられるAIアシスタントです。

ユーザーからの質問：{{user_question}}

上記の質問に、分かりやすく丁寧に答えてください。
```

**ポイント：** `{{変数名}}` で変数を参照します

### 複数の変数を使う例

**入力変数：**
- `topic`：話題（例：料理、旅行、スポーツ）
- `detail_level`：詳しさ（例：簡単、普通、詳しく）
- `target_audience`：対象者（例：小学生、大人）

**プロンプト：**
```
対象者：{{target_audience}}

{{topic}}について、{{detail_level}}説明してください。

説明のポイント：
- 対象者に合わせた言葉遣い
- 具体例を含める
- 分かりやすい構成
```

### 変数を使った条件分岐（if文）

より高度な使い方として、変数の値によってAIへの指示を切り替えることができます。
これを「条件分岐」と呼びます。

**例：相手によって説明の仕方を変える**

```
あなたはAIアシスタントです。

{% if detail_level == "簡単" %}
小学生にも分かるように、ひらがなを多用して説明してください。
{% elif detail_level == "普通" %}
一般的な大人向けに、標準的な言葉で説明してください。
{% else %}
専門家向けに、専門用語を用いて詳細に説明してください。
{% endif %}

トピック：{{topic}}
```

**解説：**
- `{% if ... %}`：もし〜なら
- `{% elif ... %}`：そうでなく、もし〜なら
- `{% else %}`：どれにも当てはまらないなら
- `{% endif %}`：条件分岐の終わり

※これは「Jinja2（ジンジャーツー）」という書き方を使っていますが、覚えるのはこのパターンだけでOKです。

### ノード間での変数の受け渡し

```
[開始ノード]
  ↓ user_question
[LLMノード1] ← 質問に回答
  ↓ output（生成された回答）
[LLMノード2] ← {{LLMノード1.output}}を要約
  ↓
[終了ノード]
```

**LLMノード2のプロンプト例：**
```
以下の文章を3行で要約してください：

{{LLMノード1.output}}
```

---

## 5. 実践：AIアシスタントを作る

### 演習1: シンプルな質問応答ボット

**目標：** ユーザーの質問に答えるボットを作成

#### 手順

1. **ワークフロー作成**
   - 名前：「質問応答ボット」

2. **開始ノードの設定**
   - 入力変数を追加
     - フィールド名：`question`
     - タイプ：テキスト
     - 必須：はい

3. **LLMノードの追加と設定**
   - モデル：gemini-2.5-flash
   - Temperature：0.7
   - Max Tokens：1024

   **プロンプト：**
   ```
   あなたは親切で知識豊富なAIアシスタントです。
   ユーザーの質問に対して、正確で分かりやすい回答を提供してください。

   質問：{{question}}

   回答：
   ```

4. **終了ノードの設定**
   - 出力変数：`{{text}}`

5. **テスト実行**
   - 質問例：「プロンプトエンジニアリングとは何ですか？」

### 演習2: レビュー感情分析ツール

**目標：** 商品レビューをポジティブ/ネガティブ/ニュートラルに分類

#### 入力変数
- `review_text`：レビュー文

#### プロンプト

```
あなたは商品レビューの分析専門家です。

以下の例を参考に、レビューを分類してください。

【例1】
レビュー：「素晴らしい商品です。買って良かった！」
分類：ポジティブ
理由：満足度の高い表現が使われている

【例2】
レビュー：「思っていたものと違いました。残念です。」
分類：ネガティブ
理由：失望を表す表現が使われている

【例3】
レビュー：「普通の商品です。特に良くも悪くもない。」
分類：ニュートラル
理由：中立的な表現

【分類対象】
レビュー：{{review_text}}

以下の形式で回答してください：
分類：[ポジティブ/ネガティブ/ニュートラル]
理由：[簡潔に説明]
```

#### テスト用レビュー

```
「配送が早く、商品も期待通りでした。また利用したいです。」
→ ポジティブ

「値段の割には品質が良くないと感じました。」
→ ネガティブ

「可もなく不可もなく、普通の商品だと思います。」
→ ニュートラル
```

### 演習3: ブログ記事生成アシスタント

**目標：** テーマを入力すると、構成まで考えてブログ記事を生成

#### 入力変数
- `article_topic`：記事のテーマ
- `target_length`：文字数（500/1000/2000）
- `tone`：トーン（カジュアル/フォーマル）

#### ワークフロー構成

```
[開始] → [LLMノード1：構成案] → [LLMノード2：本文生成] → [終了]
```

#### LLMノード1のプロンプト（構成案作成）

```
あなたはプロのライターです。

以下の条件でブログ記事の構成案を作成してください：

テーマ：{{article_topic}}
文字数：約{{target_length}}文字
トーン：{{tone}}

以下の形式で構成案を出力してください：

タイトル：
導入：（どのような書き出しにするか）
本文の構成：
1. 見出し1
   - 含める内容
2. 見出し2
   - 含める内容
3. 見出し3
   - 含める内容
まとめ：（どのように締めくくるか）
```

#### LLMノード2のプロンプト（本文生成）

```
以下の構成案に基づいて、ブログ記事の本文を書いてください。

【構成案】
{{LLMノード1.output}}

【執筆ルール】
- トーン：{{tone}}
- 目標文字数：{{target_length}}文字
- 読みやすい段落構成
- 具体例を含める
{% if tone == "カジュアル" %}
- 親しみやすい口調（です・ます調）
- 適度に体験談を混ぜる
{% else %}
- フォーマルな文体
- 客観的な情報を中心に
{% endif %}

それでは、記事本文をお願いします：
```

#### テスト実行

**入力例：**
- article_topic：「在宅勤務を快適にする方法」
- target_length：1000
- tone：カジュアル

### 演習4: カスタマーサポートボット

**目標：** 丁寧な言葉遣いで顧客対応するボット

#### 入力変数
- `customer_inquiry`：顧客の問い合わせ
- `product_category`：製品カテゴリ（電化製品/衣類/食品）

#### プロンプト

```
あなたは当社のカスタマーサポート担当者です。

【対応方針】
- 常に丁寧で親切な対応
- 顧客の不安を取り除く
- 具体的で分かりやすい説明
- 必要に応じて次のステップを案内

【製品カテゴリ】
{{product_category}}

【お客様からのお問い合わせ】
{{customer_inquiry}}

以下の形式で回答してください：

■ お問い合わせ内容の確認
（お客様の質問を言い換えて確認）

■ 回答
（分かりやすく丁寧に説明）

■ 追加のご案内
（必要に応じて、関連情報や次のステップを案内）

■ 締めの言葉
（感謝の言葉や、何かあればいつでもご連絡くださいという旨）
```

---

## よくある質問（FAQ）

### Q1: プロンプトが長すぎると問題ありますか？

**A:** 長すぎるプロンプトは以下の問題があります：
- コストが高くなる
- 処理が遅くなる
- AIが重要な指示を見落とすことがある

**推奨：** 必要な情報に絞り、簡潔に書く

### Q2: Temperatureは何に設定すればいいですか？

**A:** タスクによって変えましょう：

| タスク | 推奨値 |
|--------|--------|
| 事実確認、計算 | 0.0 - 0.3 |
| 一般的なQ&A | 0.5 - 0.7 |
| 創作、アイデア出し | 0.8 - 1.0 |

### Q3: AIの回答が期待と違う場合は？

**A:** 以下を試してください：
1. プロンプトをより具体的にする
2. 例（Few-shot）を追加する
3. 出力形式を明示する
4. ステップバイステップで指示する

### Q4: 変数名に使える文字は？

**A:** 以下のルールがあります：
- 英数字とアンダースコア `_` のみ
- 数字から始めない
- スペースは使えない

**良い例：** `user_question`, `topic1`, `review_text`
**悪い例：** `ユーザー質問`, `1topic`, `review text`

---

## まとめ

### この回で学んだこと

✅ **LLMノードの基本**
- ストリーミングとブロッキングの違い
- モデルの選び方
- Temperatureなどのパラメータ設定

✅ **プロンプトの書き方**
- 役割、タスク、制約条件、出力形式の指定
- Few-shot（例示）の活用
- ステップバイステップの指示

✅ **変数の使い方**
- `{{変数名}}` で動的なプロンプト作成
- 複数の変数を組み合わせる
- ノード間で結果を受け渡す

✅ **実践的なアプリケーション**
- 質問応答ボット
- 感情分析ツール
- ブログ記事生成
- カスタマーサポート

### 次のステップ

次回は、さらに高度な機能を学びます：

- **第3回：ナレッジベースとRAG**
  - 独自のドキュメントを使った回答生成
  - PDFやWebサイトの情報を活用
  - より正確で信頼性の高いAIアプリ

### 練習課題

以下のアプリケーションを自分で作ってみましょう：

1. **翻訳アシスタント**
   - 入力：日本語の文章、翻訳先言語
   - 出力：翻訳結果

2. **文章添削ツール**
   - 入力：添削してほしい文章
   - 出力：改善案と理由

3. **キャッチコピー生成**
   - 入力：商品名、特徴
   - 出力：3つのキャッチコピー案

### 参考リンク

- [Dify公式ドキュメント](https://docs.dify.ai/)
- [プロンプトエンジニアリングガイド](https://www.promptingguide.ai/jp)

---

**お疲れ様でした！** 分からないことがあれば、コミュニティやサポートに質問してみましょう。
